<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Badge Checker Pro</title>
    <style>
        :root {
            --primary: #00a2ff;
            --success: #c8ffd1;
            --danger: #ffcfcf;
            --bg: #f4f4f9;
            --warning: #fff3cd;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: var(--bg); color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #111; display: flex; align-items: center; gap: 10px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input { flex: 1; min-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; transition: border-color 0.2s; }
        input:focus { border-color: var(--primary); }
        button { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .status { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 500; display: none; }
        .status.info { display: block; background: #e3f2fd; color: #0d47a1; }
        .status.error { display: block; background: var(--danger); color: #b71c1c; }
        .status.warning { display: block; background: var(--warning); color: #856404; border: 1px solid #ffeeba; }
        
        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 8px; border: 1px solid #ddd; }
        table { border-collapse: collapse; width: 100%; background: #fff; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 15px; text-align: left; }
        th { background: #f8f9fa; font-weight: 600; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; }
        tr.badge-owned { background-color: var(--success) !important; }
        tr.badge-owned td:first-child::before { content: "‚úÖ "; }
        tr:hover { background: #fcfcfc; }
        
        .loader { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>üèÜ Badge Checker</h1>
    
    <div class="input-group">
        <input type="number" id="userid" placeholder="–í–≤–µ–¥–∏—Ç–µ Roblox User ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: 257770975)">
        <button id="checkBtn" onclick="checkBadges()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–µ–π–¥–∂–∏</button>
    </div>

    <div id="status" class="status"></div>
    
    <div class="table-container" id="tableContainer" style="display:none;">
        <table id="resultsTable">
            <thead><tr id="tableHeader"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
const CONFIG = {
    GOOGLE_KEY: "AIzaSyA--6tN4m7UM0FwQyrzZ-OYbEZHfBL3YF0",
    SHEET_ID: "17HE0xTN5tuq8BAkwvtP17tlJW8rpFNI3WzbI4LYXchk",
    RANGE: "Main List",
    WORKER_URL: "https://icy-shadow-34fb.max-kash2008.workers.dev",
    TOWER_API_KEY: "e8216559-7baa-4447-8bf4-8148110345e9-841fee72-065f-4133-b8c0-2e6e95a15a40"
};

const statusEl = document.getElementById("status");
const btn = document.getElementById("checkBtn");

function updateStatus(msg, type = "info") {
    if (!msg) {
        statusEl.style.display = "none";
        return;
    }
    statusEl.textContent = msg;
    statusEl.className = `status ${type}`;
    if(type === "info") {
        statusEl.innerHTML = `<span class="loader"></span> ${msg}`;
    }
}

async function checkBadges() {
    const userIdInput = document.getElementById("userid").value;
    const userId = parseInt(userIdInput, 10);
    
    if (!userId) return updateStatus("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π User ID", "error");

    btn.disabled = true;
    updateStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã...");

    try {
        const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.RANGE}?key=${CONFIG.GOOGLE_KEY}`;
        const sheetRes = await fetch(sheetUrl);
        const data = await sheetRes.json();

        if (data.error) throw new Error(data.error.message);
        const rows = data.values;
        if (!rows || rows.length < 2) throw new Error("–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");

        const headers = rows[0];
        const badgeColIndex = headers.findIndex(h => /badge|–±–µ–π–¥–∂|—Å—Å—ã–ª–∫–∞|id|–∞–π–¥–∏/i.test(h));
        
        if (badgeColIndex === -1) throw new Error("–°—Ç–æ–ª–±–µ—Ü —Å ID –±–µ–π–¥–∂–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω.");

        const badgeMap = []; 
        const badgeIds = [];

        for (let i = 1; i < rows.length; i++) {
            const cellValue = String(rows[i][badgeColIndex] || "").trim();
            let bId = null;
            const urlMatch = cellValue.match(/badges\/(\d+)/);
            if (urlMatch) {
                bId = parseInt(urlMatch[1], 10);
            } else if (/^\d+$/.test(cellValue)) {
                bId = parseInt(cellValue, 10);
            }
            
            badgeMap.push({ rowIndex: i, badgeId: bId });
            if (bId) badgeIds.push(bId);
        }

        if (badgeIds.length === 0) throw new Error("ID –±–µ–π–¥–∂–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");

        updateStatus(`–ü—Ä–æ–≤–µ—Ä–∫–∞ ${badgeIds.length} –±–µ–π–¥–∂–µ–π —á–µ—Ä–µ–∑ TowerStats...`);

        const payload = {
            id: userId,
            badges: badgeIds.map(id => Number(id)),
            apiKey: CONFIG.TOWER_API_KEY
        };

        const workerRes = await fetch(CONFIG.WORKER_URL, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify(payload)
        });

        const result = await workerRes.json();

        // If credits are empty, we tell the user clearly.
        if (result.error === "Insufficient credits") {
            updateStatus("TowerStats: –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω (Insufficient credits). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", "error");
            // Still render the table so they can see the list, even if ownership isn't checked
            renderTable(headers, rows, badgeMap, new Set());
            return;
        } else if (result.error) {
            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${result.error}`);
        }
        
        if (!Array.isArray(result)) {
            throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
        }
        
        // Ensure all IDs in the set are numbers for strict comparison
        const ownedSet = new Set(result.map(id => Number(id)));

        renderTable(headers, rows, badgeMap, ownedSet);
        updateStatus("–ì–æ—Ç–æ–≤–æ! –ù–∞–π–¥–µ–Ω–Ω—ã–µ –±–µ–π–¥–∂–∏ –æ—Ç–º–µ—á–µ–Ω—ã –∑–µ–ª–µ–Ω—ã–º.", "info");
        setTimeout(() => updateStatus(""), 3000);

    } catch (err) {
        console.error("Full Error Context:", err);
        updateStatus("–û—à–∏–±–∫–∞: " + err.message, "error");
    } finally {
        btn.disabled = false;
    }
}

function renderTable(headers, rows, badgeMap, ownedSet) {
    const headerRow = document.getElementById("tableHeader");
    const tableBody = document.getElementById("tableBody");
    
    headerRow.innerHTML = headers.map(h => `<th>${h}</th>`).join("");
    
    let bodyHtml = "";
    for (let i = 0; i < badgeMap.length; i++) {
        const rowData = rows[i + 1];
        const badgeId = badgeMap[i].badgeId;
        // Compare as numbers
        const isOwned = badgeId && ownedSet.has(Number(badgeId));
        
        bodyHtml += `<tr class="${isOwned ? 'badge-owned' : ''}">`;
        for (let j = 0; j < headers.length; j++) {
            bodyHtml += `<td>${rowData[j] || ""}</td>`;
        }
        bodyHtml += `</tr>`;
    }
    
    tableBody.innerHTML = bodyHtml;
    document.getElementById("tableContainer").style.display = "block";
}
</script>

</body>
</html>
